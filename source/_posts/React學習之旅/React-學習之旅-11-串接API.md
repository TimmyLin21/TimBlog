---
title: React å­¸ç¿’ä¹‹æ—…(11) - ä¸²æ¥API
date: 2022-04-24 10:44:51
tags: [React, fetch, RESTful API, async/await, try/catch]
categories:
- React å­¸ç¿’ä¹‹æ—…
description: åœ¨çœŸå¯¦çš„å°ˆæ¡ˆä¸­ï¼Œè³‡æ–™å¾€å¾€ä¸æ˜¯å­˜åœ¨æ–¼æœ¬åœ°ç«¯ï¼Œè€Œæ˜¯é ç«¯çš„è³‡æ–™åº«ä¸­ã€‚å› æ­¤éœ€è¦è—‰ç”± API å‘å¾Œç«¯è«‹æ±‚è³‡æ–™æˆ–è€…ç™¼é€è³‡æ–™ï¼Œè€Œå¾Œç«¯åœ¨ç¶“éä¸€é€£ä¸²çš„è™•ç†å¾Œå‘è³‡æ–™åº«å–å¾—è³‡æ–™å†å›å‚³åˆ°æœ¬åœ°ç«¯ã€‚è€Œä»Šå¤©æƒ³è·Ÿå¤§å®¶åˆ†äº«çš„æ˜¯ä¸»è¦æ˜¯å‰åŠæ®µçš„æ­¥é©Ÿï¼Œä¹Ÿå°±æ˜¯åœ¨ React ä¸­å¦‚ä½•è—‰ç”± API å‘å¾Œç«¯è«‹æ±‚è³‡æ–™æˆ–è€…ç™¼é€è³‡æ–™ï¼Œå°±è®“æˆ‘å€‘ä¸€èµ·çœ‹ä¸‹å»å§ï¼
---
## å‰è¨€

åœ¨çœŸå¯¦çš„å°ˆæ¡ˆä¸­ï¼Œè³‡æ–™å¾€å¾€ä¸æ˜¯å­˜åœ¨æ–¼æœ¬åœ°ç«¯ï¼Œè€Œæ˜¯é ç«¯çš„è³‡æ–™åº«ä¸­ã€‚å› æ­¤éœ€è¦è—‰ç”± API å‘å¾Œç«¯è«‹æ±‚è³‡æ–™æˆ–è€…ç™¼é€è³‡æ–™ï¼Œè€Œå¾Œç«¯åœ¨ç¶“éä¸€é€£ä¸²çš„è™•ç†å¾Œå‘è³‡æ–™åº«å–å¾—è³‡æ–™å†å›å‚³åˆ°æœ¬åœ°ç«¯ã€‚è€Œä»Šå¤©æƒ³è·Ÿå¤§å®¶åˆ†äº«çš„æ˜¯ä¸»è¦æ˜¯å‰åŠæ®µçš„æ­¥é©Ÿï¼Œä¹Ÿå°±æ˜¯åœ¨ React ä¸­å¦‚ä½•è—‰ç”± API å‘å¾Œç«¯è«‹æ±‚è³‡æ–™æˆ–è€…ç™¼é€è³‡æ–™ï¼Œå°±è®“æˆ‘å€‘ä¸€èµ·çœ‹ä¸‹å»å§ï¼

## fetch

ä»Šå¤©è¦åˆ†äº«çš„ä¸²æ¥æ–¹å¼æ˜¯ä½¿ç”¨ç¾ä»Šå¤§å¤šç€è¦½å™¨éƒ½æ”¯æ´çš„ fetch apiã€‚å‡å¦‚ä»Šå¤©æ˜¯åœ¨ç›£è½äº‹ä»¶å¾Œæ‰æœƒç™¼é€è«‹æ±‚ï¼Œæˆ‘å€‘å°±å¯ä»¥åœ¨ç›£è½çš„å‡½ç¤ºå…§ä½¿ç”¨ fetchï¼Œfetch å¯ä»¥å¸¶å…¥å…©å€‹åƒæ•¸ï¼Œç¬¬ä¸€å€‹æ˜¯ api çš„ç¶²å€ï¼Œè€Œç¬¬äºŒå€‹å‰‡æ˜¯ headerï¼Œheader åˆåŒ…å«è«‹æ±‚çš„æ–¹æ³•ã€æŒ¾å¸¶çš„è³‡æ–™ä»¥åŠä¸€äº›é™„åŠ çš„ header è³‡è¨Šã€‚é è¨­çš„æƒ…æ³ä¸‹æ˜¯ä½¿ç”¨ GETï¼Œå› æ­¤è‹¥æ˜¯å–®ç´”è«‹æ±‚è³‡æ–™çš„è©±å°±ä¸éœ€è¦å¦å¤–åŠ ä¸Š headerã€‚åœ¨ç™¼å‡ºè«‹æ±‚å¾Œæœƒå›å‚³ä¸€å€‹ Promise ç‰©ä»¶ï¼Œæˆ‘å€‘å°±å¯ä»¥ä½¿ç”¨ then å»æ¥æ”¶æˆåŠŸå›å‚³çš„è³‡æ–™ã€‚ä½†æ˜¯é€™æ™‚å–å¾—çš„è³‡æ–™æ˜¯ JSON çš„å½¢å¼ï¼ŒJSON ä¸¦ä¸èƒ½ä½¿ç”¨é™£åˆ—æ–¹æ³•ï¼Œå› æ­¤æˆ‘å€‘éœ€è¦ä½¿ç”¨ `json()` å°‡ä»–è½‰æˆç‰©ä»¶ã€‚ä¹‹å¾Œå°‡å›å‚³ä¸€å€‹ prmoise å‡ºå»å†ä½¿ç”¨ then å»æ¥æ”¶çµæœä¸¦ä½¿ç”¨ useState ä¸­çš„ setData() å°‡è³‡æ–™å„²å­˜èµ·ä¾†ï¼Œé€™æ¨£å°±æ˜¯ä¸€å€‹ç°¡å–®çš„è«‹æ±‚è³‡æ–™æµç¨‹ã€‚

```js
  function fetchHandler() {
    fetch('url')
      .then((response) => {
        return response.json();
      }).then((data) => {
        setData(data);
      })
  }
```

```js
  function fetchPostHandler() {
    fetch('url', {
      method: 'POST',
      body: JSON.stringify(data),
      headers: {
        'Content-Type':'application/json
      }
    })
      .then((response) => {
        return response.json()
      }).then((data) => {
        console.log(data);
      })
  }
```

### async/await

é™¤äº†ä¸Šè¿°çš„å¯«æ³•å¤–ï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥ä½¿ç”¨ async/await çš„å¯«æ³•ã€‚ç”±æ–¼é€™æ˜¯ä¸€å€‹éåŒæ­¥è¡Œç‚ºï¼Œå› æ­¤åœ¨å‡½å¼å‰åŠ ä¸Š asyncï¼Œä¹‹å¾Œæˆ‘å€‘éœ€è¦å–å¾— fetch å¾Œå¾—åˆ°çš„ promise ä¸¦è³¦äºˆåˆ° response é€™å€‹è®Šæ•¸ä¸Šï¼Œæ‰€ä»¥æˆ‘å€‘åœ¨ fetch() å‰åŠ ä¸Š awaitã€‚åŒæ¨£åœ°ï¼Œæˆ‘å€‘éœ€è¦ç­‰å¾… response è½‰åŒ–ç‚ºç‰©ä»¶å¾Œçš„ promise å› æ­¤ä¹Ÿæ˜¯åœ¨ `response.json()` å‰åŠ ä¸Š await ä¸¦è³¦äºˆåˆ° data ä¸Šã€‚ä»¥ async/await çš„æ–¹å¼æ’°å¯«å°±æœƒç°¡æ½”æ˜ç­è¨±å¤šï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å˜—è©¦çœ‹çœ‹ã€‚

```js
  async function fetchHandler() {
    const response = await fetch('url')
    const data = await response.json()

    setData(data);
  }
```

## Loading state

é€šå¸¸åœ¨è«‹æ±‚è³‡æ–™æ™‚ï¼Œç‚ºäº†å¢åŠ ä½¿ç”¨è€…é«”é©—ï¼Œéƒ½æœƒåŠ ä¸Šæ–‡å­—æˆ– spinner çš„æ•ˆæœè®“ä½¿ç”¨è€…çŸ¥é“è³‡æ–™æ­£åœ¨è¼‰å…¥ä¸­ã€‚å°±è®“æˆ‘å€‘ä¸€èµ·ä¾†è©¦è‘—åŠ å…¥ loading çš„æ•ˆæœå§ã€‚é¦–å…ˆï¼Œæˆ‘å€‘å¯ä»¥å®šç¾©ä¸€å€‹ isLoading çš„ stateï¼Œä¸¦çµ¦äºˆ false çš„åˆå§‹å€¼ã€‚åœ¨ç™¼é€è«‹æ±‚å‰ï¼Œæˆ‘å€‘å°‡ isLoading çš„å€¼è¨­ç‚º true ç›´åˆ°è³‡æ–™å„²å­˜å¾Œå†æŠŠ isLoading è¨­ç‚º falseï¼Œè€Œé€™å€‹éç¨‹é–“ï¼Œæˆ‘å€‘å°±å¯ä»¥åˆ©ç”¨åˆ¤æ–·å¼å»æ±ºå®šè¦é¡¯ç¤ºçš„å…§å®¹ã€‚ç”šè‡³æˆ‘å€‘é‚„å¯ä»¥åŠ ä¸Šå‡å¦‚å–å¾—çš„è³‡æ–™é•·åº¦ç‚ºé›¶çš„åˆ¤æ–·ï¼Œé€™æ¨£å°±ç®—è³‡æ–™æˆåŠŸå–å¾—ï¼Œä½†æ²’æœ‰è³‡æ–™ï¼Œä½¿ç”¨è€…ä¹Ÿä¸æœƒå¾—åˆ°ç©ºç™½çš„ç•«é¢äº†ã€‚

```js
  async function fetchHandler() {
    setIsLoading(true);
    const response = await fetch('url')
    const data = await response.json()

    setData(data);
    setIsLoading(false);
  }

  return (
    <section>
      {!isLoading && data.length > 0 && <DataList data={data} />}
      {!isLoading && data.length === 0 && <p>No data found.</p>}
      {isLoading && <p>Data is loading.</p>}
    </section>
  )
```

## Error

å‰›å‰›ä»‹ç´¹çš„éƒ¨åˆ†éƒ½æ˜¯æˆåŠŸå–å¾—è³‡æ–™çš„ç¤ºç¯„ï¼Œç¾åœ¨ä¾†èªªèªªå¦‚ä½•è™•ç†è«‹æ±‚å¤±æ•—ã€‚å¦‚åŒ loading ç‹€æ…‹ï¼Œæˆ‘å€‘ä¸€æ¨£å¯ä»¥å®šç¾©ä¸€å€‹ error çš„ state ç”¨ä¾†è™•ç†éŒ¯èª¤ç•«é¢çš„é¡¯ç¤ºï¼Œä¸éåˆå§‹å€¼çš„éƒ¨åˆ†æˆ‘å€‘è¨­ç‚º nullã€‚åœ¨ä½¿ç”¨ fetch è«‹æ±‚è³‡æ–™æ™‚ï¼Œç•¶éŒ¯èª¤ç™¼ç”Ÿæ™‚ä¸¦ä¸æœƒå‡ºç¾ Error çš„ç‰©ä»¶ï¼Œæ‰€ä»¥æ²’è¾¦æ³•ç›´æ¥ä½¿ç”¨ catch å»æ¥æ”¶éŒ¯èª¤è¨Šæ¯ï¼Œå› æ­¤æˆ‘å€‘éœ€è¦åˆ¤æ–· response.ok æ˜¯å¦ç‚º trueï¼Œè‹¥å¦å‰‡ä¸Ÿå‡ºä¸€å€‹éŒ¯èª¤çš„è¨Šæ¯ï¼Œé€™æ¨£æˆ‘å€‘å°±èƒ½æ­é… try/catch å»è™•ç†éŒ¯èª¤ç™¼ç”Ÿçš„ç‹€æ…‹ï¼Œè€Œè‹¥æ˜¯æƒ³è¦æŸ¥çœ‹éŒ¯èª¤çš„ç‹€æ…‹ç¢¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `response.status` åšæŸ¥è©¢ã€‚è€Œåœ¨ç•«é¢æ¸²æŸ“ä¸Šï¼Œå°±å¯ä»¥å†åŠ ä¸Š error æ˜¯å¦ç‚º true çš„åˆ¤æ–·ï¼Œé€™æ¨£ä½¿ç”¨è€…å°±èƒ½å¤ çŸ¥é“è³‡æ–™ç›®å‰æ˜¯ç­‰å¾…ä¸­é‚„æ˜¯è«‹æ±‚éŒ¯èª¤æˆ–è€…æ²’æœ‰æª”æ¡ˆäº†ã€‚

```js
  async fetchHandler() {
    setError(null)
    setIsLoading(true);
    try {
      const response = await fetch("url");
      if (!response.ok) {
        throw new Error('Something went wrong!')
      }
      const data = await response.json();
      setData(data);
    } catch (error) {
      setError(error.message)
    }
    setIsLoading(false);
  }

  <section>
    {!isLoading && data.length > 0 && <DataList data={data} />}
    {!isLoading && data.length === 0 && !error && <p>No data found.</p>}
    {!isLoading && error && <p>{error}</p>}
    {isLoading && <p>Data is loading.</p>}
  </section>
```

## æ­é… useEffect()

é™¤äº†åœ¨æ¥æ”¶åˆ°ç›£è½äº‹ä»¶ç„¶å¾Œè«‹æ±‚è³‡æ–™å¤–ï¼Œå…¶å¯¦æ¯”è¼ƒå¸¸è¦‹çš„åšæ³•æ˜¯ç•¶å…ƒä»¶ç”Ÿæˆæ™‚å°±ç™¼é€è«‹æ±‚ï¼Œè€Œé€™æ™‚å°±å¯ä»¥ä½¿ç”¨ useEffect()ã€‚æˆ‘å€‘å¯ä»¥ç›´æ¥å°‡ fetchHandler() åŠ å…¥åˆ° useEffect() ä¸­ï¼Œè‡³æ–¼ dependencies çš„éƒ¨åˆ†ï¼Œå› ç‚ºæœ‰ä½¿ç”¨åˆ°çš„è®Šæ•¸éƒ½éœ€è¦åŠ å…¥ dependenciesï¼Œæ‰€ä»¥æˆ‘å€‘å°‡ fetchHandler ä¹ŸåŠ å…¥ã€‚ä½†é€™æ™‚æœƒæœ‰ä¸€å€‹å•é¡Œï¼Œå°±æ˜¯æ¯æ¬¡è³‡æ–™é‡æ–°æ¸²æŸ“æ™‚ï¼ŒfetchHandler() éƒ½æœƒæ˜¯ä¸€å€‹å…¨æ–°çš„å‡½ç¤ºï¼Œå› æ­¤æœƒé€²å…¥ç„¡é™å¾ªç’°ï¼Œè€Œé¢å°é€™å€‹å•é¡Œï¼Œæˆ‘å€‘å°±å¿…é ˆä½¿ç”¨ä¹‹å‰å­¸åˆ°çš„ useCallback()ï¼Œç¨å¾®æ”¹å¯«äº†ä¹‹å¾Œï¼Œæˆ‘å€‘å°±å¯ä»¥åœ¨å…ƒä»¶å‰µç«‹æ™‚å–å¾—è³‡æ–™å›‰ï¼æœ€å¾Œï¼Œå› ç‚º hoisting çš„é—œä¿‚è¨˜å¾—å°‡ useEffect() ç§»åˆ° fetchHandler() ä¸‹æ–¹ã€‚

```js
  const fetchHandler() = useCallback(async () => {
    setError(null)
    setIsLoading(true);
    try {
      const response = await fetch("url");
      if (!response.ok) {
        throw new Error('Something went wrong!')
      }
      const data = await response.json();
      setData(data);
    } catch (error) {
      setError(error.message)
    }
    setIsLoading(false);
  }, [])

  useEffect(() => {
    fetchHandler()
  }, [fetchHandler])
```

## çµèª

ä»¥ä¸Šå°±æ˜¯é—œæ–¼åœ¨ React ä¸­å¦‚ä½•è«‹æ±‚æˆ–è€…ç™¼é€è³‡æ–™çš„ä»‹ç´¹ï¼Œä»¥ä¸Šä»‹ç´¹éƒ½æ˜¯ä»¥ RESTful api ç‚ºä¸»ï¼Œè‡³æ–¼ GraphQL api çš„éƒ¨åˆ†ï¼Œæœ‰æ©Ÿæœƒå†è·Ÿå¤§å®¶ä»‹ç´¹ï¼Œæ„Ÿè¬å¤§å®¶çš„é–±è®€ï¼Œé‚£æˆ‘å€‘å°±ä¸‹æ¬¡è¦‹å›‰ ğŸ¤ŸğŸ¼
